language: python

python: '3.6'
install: pip install tox
script: tox
# Checks whether current version matches current tag
before_deploy: |
  pip install bump2version;
  python -c "assert '$(git describe --tags)' == '$(bump2version --dry-run --list minor | grep current_version | sed -r s,\"^.*=\",,)'"
deploy:
  provider: pypi
  user: $PYPI_USER
  password: $PYPI_PASSWORD
  skip_cleanup: true
  on:
    tags: true
# Triggers building Docker containers for both current tag, and "latest"
after_deploy: >
  curl -H "Content-Type: application/json"
  --data '{"docker_tag": "latest"}'
  -X POST https://registry.hub.docker.com/u/brewblox/brewblox-service/trigger/$DOCKER_TOKEN/;
  curl -H "Content-Type: application/json"
  --data '{"source_type": "Tag", "source_name": "$(git describe --tags)"}'
  -X POST https://registry.hub.docker.com/u/brewblox/brewblox-service/trigger/$DOCKER_TOKEN/;